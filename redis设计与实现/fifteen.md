###  15.  主从复制

> 使得主从服务器上的数据保持一致，使用slaveof 命令

* 1. 从节点在连接到主节点时，发送SYNC命令（2.8版本后发送PSYNC命令，解决旧版断线重连后的复制机制）
  2. 主节点在接收到从节点的命令后，后台进行bgsave操作，即把自己当前的数据做一个RDB备份发给从节点；
  3. 在这之后，主节点会记录改变自己数据状态的命令，并实时发送到从节点，从而保证了主从的一致性；
* PSYNC命令的讲解：
  * 在原来SYNC命令原理的基础上加上偏移量，主从节点之间都要维护的变量
  * 主从节点在正常的情况下维护的偏移量是一致的，如果出现了断线的情况，就会有不同的偏移量；
  * 复制积压缓冲区的理解：
    * 在发送偏移量的同时，会创建一个积压缓冲区，用于缓存已经发送的数据，默认的大小为1M；
    * 如果发生断线故障时，由偏移量以及积压缓冲区的内容来执行部分复制还是完全复制；
  * 服务器运行ID
    * 服务器在启动的时候一般是由自己运行的ID值，在初次复制时，主服务器会把ID值，传给从服务器；
    * 如果在断线重连后出现ID值一样的情况，表明：只需要执行部分同步操作；
    * 如果不同，主服务器需要执行完整的重同步操作；
  * 命令的实现：
    * 调用的2中方法：
      * 在之前没有执行过同步的操作时，会发出PSYNC ？ -1 要去主服务器完全同步；
      * PSYNC 【runid】【offset】 表示运行ID和偏移量；
    * 返回结果的三种：
      * FULLPSYNC 【runid】【offset】表示需要执行完全的复制；
      * continue  表示部分的全同步
      * 如果返回-Error  表示识别不了次命令，可能是版本较低，无法识别；

* 复制的实现
  * slave ip   port    从服务器需要记录主服务器的IP和port  ，此命令是一个异步命令
  * 根据主服务器的IP和port，与主服务器进行套接字连接，从服务器是主服务器的客户端；
  * 发送ping命令，一方面为了测试套接字创建后的读写是否正常，另外测试主服务器是否可以是否可以正常处理命令；
  * 一般的，返回的结果有以下：
    *  不能在指定的时间内读取出返回的内容，那么需要重新与主服务器建立套接字；
    * 返回一个错误，表示主服务器现在不能处理请求，可能是由于在处理一个后台运行的命令；
    * 如果收到pong后，表示一切正常，即可进行下一个步骤；
  * 身份验证：取决于是否设置了masterauth选项，
  * 发送监听的端口：
  * 正式同步：从服务器发送PSYNC，执行把主服务器的状态同步到从服务器的状态；主服务器是客户端；
  * 命令传播：主服务器进入广播模式，主服务器一直把自己写命令向从服务器发送，从服务器一直执行；
* 心跳的检测
  * RELPCONF  offset  表示复制的偏移量    这个动作是从服务器向主服务器的，一秒一次；
  * 用来检测主从服务器之间网络是否正常，如果超过1秒没有响应，那么就认为是不正常的；
  * 配置可以防止主服务器在不安全的情况下执行写命令；
  * 检测命令是否丢失：数据在传输过程中难免会发生丢失，丢失的情况下，根据偏移量来继续补发剩余的偏移量；